{% extends 'base.html.twig' %}

{% block title %}Conversation - {{ conversation.announce.title }} - Action Sociale{% endblock %}

{% block body %}
<div class="container" style="margin-top: 30px;">
    <div class="row">
        <div class="col s12">
            <a href="{{ path('conversations_list') }}" class="btn-flat">
                <i class="material-icons left">arrow_back</i>Retour aux conversations
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col s12 m8 offset-m2">
            {# Info conversation #}
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        {{ conversation.announce.title }}
                    </span>
                    <p class="grey-text">
                        <strong>Offrant:</strong> {{ conversation.userOffrant.email }}<br>
                        <strong>Demandeur:</strong> {{ conversation.userDemandeur.email }}<br>
                        <strong>Statut:</strong>
                        <span class="chip {{ {
                            'EN_ATTENTE_REPONSE': 'orange white-text',
                            'EN_COURS': 'blue white-text',
                            'ACTIF': 'green white-text',
                            'CLOTURE_ACCORD': 'teal white-text',
                            'CLOTURE_DESACCORD': 'red white-text'
                        }[conversation.status] ?? 'grey white-text' }}">
                            {{ conversation.status|replace({'_': ' '}) }}
                        </span>
                    </p>
                </div>
            </div>

            {# Messages #}
            <div class="card">
                <div class="card-content">
                    <div id="messages-container" style="height: 400px; overflow-y: auto; padding: 15px;">
                        {% if conversation.messages|length == 0 %}
                            <p class="center-align grey-text">
                                <i class="material-icons large">chat_bubble_outline</i><br>
                                Aucun message pour le moment. Envoyez le premier !
                            </p>
                        {% else %}
                            {% for message in conversation.messages %}
                                {% set isOwn = message.senderUser == currentUser %}
                                <div class="row" style="margin-bottom: 10px;">
                                    <div class="col s12 {{ isOwn ? 'right-align' : '' }}">
                                        <div class="chip {{ isOwn ? 'blue white-text' : 'grey lighten-3' }}"
                                             style="display: inline-block; max-width: 80%; text-align: left; height: auto; padding: 10px 15px; border-radius: 15px;">
                                            <div style="white-space: pre-wrap; word-wrap: break-word;">
                                                {{ message.message }}
                                            </div>
                                            <div class="{{ isOwn ? 'white-text' : 'grey-text' }}"
                                                 style="font-size: 0.8em; margin-top: 5px;">
                                                {{ message.sentAt|date('d/m/Y H:i') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Send message form #}
            {% if conversation.status not in ['CLOTURE_ACCORD', 'CLOTURE_DESACCORD'] %}
                <div class="card">
                    <div class="card-content">
                        <form id="send-message-form">
                            <div class="input-field">
                                <textarea id="message-input"
                                          class="materialize-textarea"
                                          placeholder="Écrivez votre message..."
                                          required></textarea>
                                <label for="message-input">Message</label>
                            </div>
                            <button type="submit" class="btn waves-effect waves-light blue">
                                Envoyer
                                <i class="material-icons right">send</i>
                            </button>
                        </form>
                    </div>
                </div>

                {# Close conversation buttons #}
                <div class="card">
                    <div class="card-content">
                        <p><strong>Fermer la conversation :</strong></p>
                        <form method="POST" action="{{ path('conversation_close', {id: conversation.id, type: 'ACCORD'}) }}"
                              style="display: inline-block; margin-right: 10px;"
                              onsubmit="return confirm('Confirmez-vous la fermeture avec ACCORD ? Les points seront distribués.');">
                            <button type="submit" class="btn green">
                                <i class="material-icons left">check</i>
                                Accord (échange réussi)
                            </button>
                        </form>

                        <form method="POST" action="{{ path('conversation_close', {id: conversation.id, type: 'DESACCORD'}) }}"
                              style="display: inline-block;"
                              onsubmit="return confirm('Confirmez-vous la fermeture sans accord ?');">
                            <button type="submit" class="btn red">
                                <i class="material-icons left">close</i>
                                Désaccord (pas d'échange)
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="card-panel {{ conversation.status == 'CLOTURE_ACCORD' ? 'teal lighten-4' : 'red lighten-4' }}">
                    <p class="center-align">
                        <i class="material-icons">{{ conversation.status == 'CLOTURE_ACCORD' ? 'check_circle' : 'cancel' }}</i>
                        Cette conversation est fermée
                        ({{ conversation.status == 'CLOTURE_ACCORD' ? 'Accord' : 'Désaccord' }})
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('send-message-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('messages-container');

    // Auto-scroll to bottom
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    scrollToBottom();

    // Handle form submission via AJAX
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const message = messageInput.value.trim();
            if (!message) return;

            fetch('{{ path('conversation_send_message', {id: conversation.id}) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'message=' + encodeURIComponent(message)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add message to UI
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'row';
                    messageDiv.style.marginBottom = '10px';
                    messageDiv.innerHTML = `
                        <div class="col s12 right-align">
                            <div class="chip blue white-text" style="display: inline-block; max-width: 80%; text-align: left; height: auto; padding: 10px 15px; border-radius: 15px;">
                                <div style="white-space: pre-wrap; word-wrap: break-word;">
                                    ${data.message.text}
                                </div>
                                <div class="white-text" style="font-size: 0.8em; margin-top: 5px;">
                                    ${data.message.sentAt}
                                </div>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(messageDiv);

                    // Clear input and scroll
                    messageInput.value = '';
                    M.textareaAutoResize(messageInput);
                    scrollToBottom();

                    // Reload page if conversation status changed
                    setTimeout(() => location.reload(), 500);
                } else {
                    M.toast({html: data.error || 'Erreur lors de l\'envoi'});
                }
            })
            .catch(error => {
                console.error('Error:', error);
                M.toast({html: 'Erreur réseau'});
            });
        });
    }

    // Refresh messages every 10 seconds
    setInterval(function() {
        if (document.getElementById('send-message-form')) {
            location.reload();
        }
    }, 10000);
});
</script>
{% endblock %}
