name: Deploy to o2switch

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: intl, pdo_mysql, zip
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer install --optimize-autoloader --classmap-authoritative --no-interaction

      - name: Install npm dependencies
        run: npm install --legacy-peer-deps

      - name: Build assets
        run: npm run build

      - name: Deploy to o2switch via SSH
        uses: easingthemes/ssh-deploy@v4
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          SOURCE: "./"
          TARGET: ${{ secrets.REMOTE_PATH }}
          EXCLUDE: "/node_modules/, /.git/, /var/cache/, /var/log/, /.env.local, /.env.bot.local"
          SCRIPT_BEFORE: |
            echo "Starting deployment..."
          SCRIPT_AFTER: |
            cd ${{ secrets.REMOTE_PATH }}

            # Vider le cache
            php bin/console cache:clear --env=prod --no-debug
            php bin/console cache:warmup --env=prod

            # Exécuter les migrations
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod

            # Optimiser l'autoloader
            composer dump-autoload --optimize --classmap-authoritative --no-dev

            # Permissions
            chmod -R 755 var/

            # Redémarrer le bot Discord si PM2 est installé
            which pm2 && pm2 restart entraide-bot || echo "PM2 not found, skipping bot restart"

            echo "Deployment complete!"

      - name: Notify deployment success
        if: success()
        run: echo "✅ Deployment successful to o2switch!"

      - name: Notify deployment failure
        if: failure()
        run: echo "❌ Deployment failed!"
